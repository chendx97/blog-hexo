---
title: ğŸ’ å¦‚ä½•ç”¨MongoDBèšåˆç®¡é“(pipeline)å¤„ç†æ•°æ®
date: 2025-06-10 22:00:00
tags:
  - mongodb
  - pipeline
categories:
  - æŒ‡å—
cover: https://cdn.jsdelivr.net/gh/chendx97/CPics/img/202506102209816.png
---

MongoDBçš„èšåˆç®¡é“ï¼ˆAggregation Pipelineï¼‰æ˜¯ä¸€ç§å¼ºå¤§çš„æ•°æ®å¤„ç†å·¥å…·ï¼Œå…è®¸é€šè¿‡å¤šä¸ªé˜¶æ®µå¯¹æ–‡æ¡£è¿›è¡Œé€æ­¥å¤„ç†ã€è½¬æ¢å’Œåˆ†æã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ•°æ®è§†ä¸ºæµç»ä¸€ç³»åˆ—æ“ä½œçš„â€œç®¡é“â€ï¼Œæ¯ä¸ªé˜¶æ®µå¤„ç†åçš„ç»“æœä¼ é€’ç»™ä¸‹ä¸€é˜¶æ®µï¼Œæœ€ç»ˆè¾“å‡ºç›®æ ‡æ•°æ®ã€‚


![](https://cdn.jsdelivr.net/gh/chendx97/CPics/img/202506102204461.png)


æ•°æ®æŒ‰ç…§ç®¡é“ä¸­çš„æ¯ä¸ªé˜¶æ®µä¾æ¬¡æµåŠ¨ï¼›
æ¯ä¸ªé˜¶æ®µå¯¹æ•°æ®è¿›è¡Œç‰¹å®šçš„è½¬æ¢æˆ–ç­›é€‰ï¼›
å‰ä¸€é˜¶æ®µçš„è¾“å‡ºä½œä¸ºä¸‹ä¸€é˜¶æ®µçš„è¾“å…¥ï¼›


# é˜¶æ®µæ“ä½œç¬¦
æ¯ä¸ªé˜¶æ®µä»£è¡¨ä¸€ä¸ªæ•°æ®å¤„ç†æ“ä½œï¼ˆå¦‚è¿‡æ»¤ã€åˆ†ç»„ã€æ’åºç­‰ï¼‰ï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚
å‰ä¸€é˜¶æ®µçš„è¾“å‡ºä½œä¸ºä¸‹ä¸€é˜¶æ®µçš„è¾“å…¥ï¼Œå½¢æˆå¤„ç†é“¾ã€‚

## $match
åŠŸèƒ½ï¼š**è¿‡æ»¤**æ–‡æ¡£ï¼Œç±»ä¼¼SQLçš„WHEREã€‚
```py
{
    "$match": {
        "date": {
            "$gte": beginday,
            "$lte": endday
        }
    }
},
```

## $unwind
åŠŸèƒ½ï¼šå±•å¼€æ•°ç»„å­—æ®µï¼Œå°†æ•°ç»„å…ƒç´ æ‹†åˆ†ä¸ºç‹¬ç«‹æ–‡æ¡£ã€‚
```py
{
    "$unwind": "$operations"
},
```
å¦‚æœä¸€æ¡åŸæ•°æ®ä¸­æœ‰ä¸€ä¸ªé•¿åº¦ä¸º5çš„operationsæ•°ç»„ï¼Œä½¿ç”¨$unwindå¯ä»¥å¾—åˆ°5æ¡æ•°æ®ã€‚

## $group
åŠŸèƒ½ï¼šæŒ‰å­—æ®µåˆ†ç»„å¹¶è®¡ç®—èšåˆå€¼ï¼ˆæ€»å’Œã€å¹³å‡ç­‰ï¼‰ï¼Œç±»ä¼¼SQLçš„GROUP BYã€‚
```py
{
    "$group": {
        "_id": "$userid",
        "email": {"$last": "$operations.email"},
        "name": {"$last": "$operations.name"},
    }
},
```
ç¬¬ä¸€ä¸ªé”®å€¼å¯¹æ˜¯åˆ†ç»„ä¾æ®ï¼Œæ ¹æ®æ­¤å­—æ®µåˆ’åˆ†å‡ºå¤šä¸ªé€»è¾‘ç»„ã€‚
åé¢å‡ ä¸ªé”®å€¼å¯¹æ˜¯æ–°æ–‡æ¡£çš„ç»“æœï¼Œä½¿ç”¨æ“ä½œç¬¦å¯¹æ–‡æ¡£è¿›è¡Œè®¡ç®—ï¼Œåé¢çš„é˜¶æ®µåªèƒ½ä½¿ç”¨æ­¤é˜¶æ®µå£°æ˜çš„å±æ€§ã€‚

åˆ†ç»„ä¾æ®å¯ä»¥æ˜¯å­—æ®µã€è¡¨è¾¾å¼ï¼Œæˆ–è€…åµŒå¥—å¯¹è±¡ã€‚
```py
# å­—æ®µ
{
    "$group": {
        "_id": "$userid",
        "email": {"$last": "$operations.email"},
        "name": {"$last": "$operations.name"},
    }
},

# è¡¨è¾¾å¼
{
    $group: {
      _id: {
        // æå– "@" åçš„åŸŸåéƒ¨åˆ†
        domain: { $substr: ["$email", { $indexOfBytes: ["$email", "@"] }, -1] }
      },
      userCount: { $sum: 1 }
    }
}

# åµŒå¥—å¯¹è±¡
{
    "$group": {
        "_id": {
            year: { $year: "$date" },
            month: { $month: "$date" }
        },
        "email": {"$last": "$operations.email"},
        "name": {"$last": "$operations.name"},
    }
},
```

åœ¨ $group å‰ä½¿ç”¨ $match æˆ– $project å‡å°‘å¤„ç†çš„æ•°æ®é‡ã€‚

## $sort
åŠŸèƒ½ï¼šæ’åºç»“æœï¼Œç±»ä¼¼SQLçš„ORDER BYã€‚
```py
{
    "$sort": {
        "date": -1
    }
},
```

## $project
åŠŸèƒ½ï¼šé€‰æ‹©æˆ–é‡å‘½åå­—æ®µï¼Œç±»ä¼¼SQLçš„SELECTã€‚
```py
{
    "$project": {
        "_id": 0,
        "email": 1,
        "name": 1,
    }
}
```

## $limit/$skip
åŠŸèƒ½ï¼šåˆ†é¡µæŸ¥è¯¢ï¼Œç±»ä¼¼SQLçš„LIMITå’ŒOFFSETã€‚
```py
{ $sort: { amount: -1 } },   // 1. æŒ‰é‡‘é¢é™åºæ’åº
{ $skip: 3 },                // 2. è·³è¿‡å‰3æ¡ï¼ˆå³è·³è¿‡ç¬¬1é¡µï¼‰
{ $limit: 3 }                // 3. å–æ¥ä¸‹æ¥çš„3æ¡ï¼ˆç¬¬2é¡µï¼‰
```

## $addFields / $set
åŠŸèƒ½ï¼šæ–°å¢å­—æ®µæˆ–ä¿®æ”¹ç°æœ‰å­—æ®µï¼ˆä¸åˆ é™¤å…¶ä»–å­—æ®µï¼‰ã€‚
```py
{ 
    $addFields: { 
        tax: { 
            $multiply: ["$amount", 0.05] 
        } 
    } 
}
```

## $replaceRoot
åŠŸèƒ½ï¼šå°†åµŒå¥—æ–‡æ¡£æå‡ä¸ºæ ¹æ–‡æ¡£ã€‚
```py
# å°† user.details æå‡ä¸ºæ ¹
{ 
    $replaceRoot: { 
        newRoot: "$details" 
    } 
}
```

## $lookup
åŠŸèƒ½ï¼šå…³è”å…¶ä»–é›†åˆï¼Œç±»ä¼¼SQLçš„JOINã€‚
```py
{ 
    $lookup: { 
        from: "products", 
        localField: "productId", 
        foreignField: "_id", 
        as: "productDetails" 
    } 
}
```

## $natural
æŒ‰æ–‡æ¡£åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†å­˜å‚¨é¡ºåºï¼ˆè‡ªç„¶é¡ºåºï¼‰æ’åºã€‚
```py
{ 
    $natural: 1 # 1æ˜¯æ­£åºï¼Œ-1æ˜¯å€’åº
}
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®
- å°½æ—©è¿‡æ»¤ï¼šåœ¨ç®¡é“å‰æ®µä½¿ç”¨$matchã€$projectå‡å°‘åç»­å¤„ç†çš„æ•°æ®é‡ã€‚
- åˆç†ä½¿ç”¨ç´¢å¼•ï¼šä¸º$matchæˆ–$sortæ¶‰åŠçš„å­—æ®µåˆ›å»ºç´¢å¼•ã€‚
- é¿å…è¿‡åº¦æ‹†åˆ†é˜¶æ®µï¼šåˆå¹¶å¯ç®€åŒ–çš„æ“ä½œï¼Œå‡å°‘ç®¡é“é˜¶æ®µæ•°ã€‚

# è¡¨è¾¾å¼æ“ä½œç¬¦

æ¯ä¸ªé˜¶æ®µä½¿ç”¨ç‰¹å®šçš„æ“ä½œç¬¦ï¼ˆå¦‚ $matchã€$groupï¼‰å®šä¹‰æ•°æ®å¤„ç†é€»è¾‘ã€‚
æ“ä½œç¬¦å¯æ“ä½œå­—æ®µã€è®¡ç®—èšåˆå€¼æˆ–è½¬æ¢æ•°æ®ç»“æ„ã€‚

## æ•°å­¦æ“ä½œç¬¦
å¸¸ç”¨æ“ä½œç¬¦ï¼š$add, $subtract, $multiply, $divide, $mod, $floor, $ceil

$add åŠ æ³•
$substract å‡æ³•
$multiply ä¹˜æ³•
$divide é™¤æ³•
$mod å–ä½™
$floor å‘ä¸‹å–æ•´
$ceil å‘ä¸Šå–æ•´
$toDouble è½¬æ¢ä¸ºæµ®ç‚¹æ•°

```py
# è®¡ç®—è®¢å•æ€»ä»·ï¼ˆå•ä»· Ã— æ•°é‡ï¼‰
{ 
    $project: { 
        total: { 
            $multiply: ["$price", "$quantity"] 
        } 
    } 
}
```

## æ—¥æœŸæ“ä½œç¬¦
å¸¸ç”¨æ“ä½œç¬¦ï¼š$year, $month, $dayOfMonth, $hour, $dateToString

$year è·å–å¹´ä»½
$month è·å–æœˆä»½
$dayOfMonth è·å–æ—¥
$hour è·å–å½“å‰å°æ—¶
$dateToString è½¬æ¢æˆå­—ç¬¦ä¸²

```py
{
  $dateToString: {
    format: "<æ ¼å¼å­—ç¬¦ä¸²>",  // å¿…å¡«ï¼Œå®šä¹‰è¾“å‡ºæ ¼å¼
    date: "<æ—¥æœŸå­—æ®µæˆ–è¡¨è¾¾å¼>", // å¿…å¡«ï¼Œæ—¥æœŸå­—æ®µæˆ–ç”Ÿæˆæ—¥æœŸçš„è¡¨è¾¾å¼
    timezone: "<æ—¶åŒº>",        // å¯é€‰ï¼ŒæŒ‡å®šæ—¶åŒºï¼ˆå¦‚ "Asia/Shanghai"ï¼‰
    onNull: "<æ›¿ä»£å€¼>"         // å¯é€‰ï¼Œæ—¥æœŸä¸ºç©ºæ—¶çš„é»˜è®¤å€¼ï¼ˆå¦‚ "N/A"ï¼‰
  }
}
```

```py
# æå–è®¢å•å¹´ä»½å’Œæœˆä»½
{
    $project: { 
        year: { $year: "$orderDate" }, 
        month: { $month: "$orderDate" } 
    } 
}
```

## å­—ç¬¦ä¸²æ“ä½œç¬¦
å¸¸ç”¨æ“ä½œç¬¦ï¼š$substr, $concat, $toLower, $toUpper, $trim
$substr æˆªå–å­—ç¬¦ä¸²
$concat æ‹¼æ¥
$toLower è½¬æ¢ä¸ºå°å†™
$toUpper è½¬æ¢ä¸ºå¤§å†™
$trim å»æ‰é¦–å°¾ç©ºæ ¼
$split å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºæ•°ç»„

```py
{
    $project: {
      fruits: { $split: ["$textField", ","] } // æŒ‰é€—å·åˆ†å‰²
    }
}
```

```py
# æ‹¼æ¥ç”¨æˆ·åå¹¶è½¬ä¸ºå¤§å†™
{ 
    $project: { 
        fullName: { 
            $toUpper: { $concat: ["$firstName", " ", "$lastName"] 
            } 
        } 
    }
}
```

## é€»è¾‘æ“ä½œç¬¦
å¸¸ç”¨æ“ä½œç¬¦ï¼š$and, $or, $not, $condï¼ˆæ¡ä»¶åˆ¤æ–­ï¼‰

$and é€»è¾‘ä¸
$or é€»è¾‘æˆ–
$not é€»è¾‘å¦
$cond æ¡ä»¶åˆ¤æ–­
$ne ä¸ç­‰äºæŒ‡å®šå€¼
$ifNull å­—æ®µå€¼ä¸º null æˆ–å­—æ®µä¸å­˜åœ¨çš„æƒ…å†µï¼Œè¿”å›æŒ‡å®šçš„é»˜è®¤å€¼

```py
# è‹¥ nickname å­—æ®µä¸º null æˆ–ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºä¸º "Anonymous"
{
    $project: {
      displayName: { $ifNull: ["$nickname", "Anonymous"] }
    }
}
```

```py
# æ ‡è®°é«˜ä»·å€¼è®¢å•ï¼ˆé‡‘é¢ â‰¥ 1000ï¼‰
{ 
    $project: { 
        isHighValue: { 
            $cond: { 
                if: { $gte: ["$amount", 1000] }, 
                then: "Yes", 
                else: "No" 
            } 
        } 
    } 
}
```

```py
# æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯åˆ¤æ–­æ¡ä»¶ï¼Œç¬¬äºŒä¸ªæ˜¯æ¡ä»¶ä¸ºçœŸæ—¶çš„å–å€¼ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ä¸ºå‡æ—¶çš„å–å€¼
"$cond": [
    {"$eq": ["$operations.opcode", 1001]},
    "$operations.email",
    "$$REMOVE"
]
```

## èšåˆæ“ä½œç¬¦
å¸¸ç”¨æ“ä½œç¬¦ï¼š$sum, $avg, $max, $min, $push, $addToSet

$sum å–å’Œ
$avg å–å¹³å‡æ•°
$max å–æœ€å¤§å€¼
$min å–æœ€å°å€¼
$push å¾€æ•°ç»„ä¸­æ·»åŠ å…ƒç´ 
$addToSet å¾€Setä¸­æ·»åŠ å…ƒç´ ï¼Œè‡ªåŠ¨å»é‡

```py
# æ”¶é›†æ¯ä¸ªå®¢æˆ·çš„è®¢å• ID
{ 
    $group: { 
        _id: "$customer", 
        orderIds: { $push: "$_id" } 
    } 
}
```

## æ•°ç»„æ“ä½œç¬¦
å¸¸ç”¨æ“ä½œç¬¦ï¼š$size, $slice, $map, $filter

$size è·å–æ•°ç»„é•¿åº¦
$slice æˆªå–æ•°ç»„å…ƒç´ 
$map éå†æ•°ç»„
$filter è¿‡æ»¤æ•°ç»„
$nin ä¸å±äºæŒ‡å®šæ•°ç»„ä¸­çš„ä»»æ„å€¼

```py
# ç­›é€‰è¯„åˆ† â‰¥ 4 çš„è¯„è®º
{ 
    $project: { 
        topReviews: { 
            $filter: { 
                input: "$reviews", 
                as: "review", 
                cond: { $gte: ["$$review.rating", 4] 
                }
            } 
        } 
    } 
}
```

# è‡ªå®šä¹‰è„šæœ¬æ“ä½œç¬¦

## $function
$function å…è®¸åœ¨èšåˆç®¡é“ä¸­æ‰§è¡Œè‡ªå®šä¹‰çš„ JavaScript å‡½æ•°ï¼Œç”¨äºå¤„ç†å¤æ‚é€»è¾‘æˆ–å®ç°å†…ç½®æ“ä½œç¬¦æ— æ³•ç›´æ¥å®Œæˆçš„æ“ä½œã€‚

åŸºæœ¬è¯­æ³•ï¼š
```py
{
  $function: {
    body: <function>,  // JavaScript å‡½æ•°
    args: [<è¡¨è¾¾å¼1>, <è¡¨è¾¾å¼2>, ...],  // å‚æ•°åˆ—è¡¨ï¼ˆå¯å¼•ç”¨å­—æ®µæˆ–è®¡ç®—ç»“æœï¼‰
    lang: "js"         // ç›®å‰ä»…æ”¯æŒ JavaScript
  }
}
```

ä¸¾ä¾‹ï¼š
```py
{
    $project: {
      formattedName: {
        $function: {
          body: function(name) {
            return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
          },
          args: ["$name"],  // å‚æ•°ä¸ºå­—æ®µ name çš„å€¼
          lang: "js"
        }
      }
    }
}
```

JavaScript æ‰§è¡Œæ•ˆç‡ä½äºå†…ç½®æ“ä½œç¬¦ï¼Œé¿å…åœ¨å¤§æ•°æ®é›†æˆ–é«˜é¢‘æ“ä½œä¸­ä½¿ç”¨ã€‚
å‡½æ•°ä½“å¿…é¡»æ˜¯ å•è¡Œå­—ç¬¦ä¸²ï¼ˆéœ€è½¬ä¹‰æ¢è¡Œç¬¦ï¼‰æˆ–é€šè¿‡ toString() åºåˆ—åŒ–ã€‚
å‡½æ•°å‚æ•°é€šè¿‡ args ä¼ é€’ï¼Œæ”¯æŒèšåˆè¡¨è¾¾å¼ï¼ˆå¦‚ "$field"ã€{ $add: [...] }ï¼‰ã€‚

## $accumulator
$accumulator æ“ä½œç¬¦å…è®¸åœ¨èšåˆç®¡é“çš„ $group é˜¶æ®µæ‰§è¡Œè‡ªå®šä¹‰ç´¯åŠ é€»è¾‘ï¼Œé€‚ç”¨äºå¤æ‚çš„åˆ†ç»„è®¡ç®—åœºæ™¯ï¼ˆå¦‚åŠ æƒå¹³å‡ã€åŠ¨æ€æ•°æ®ç»“æ„ç»´æŠ¤ï¼‰ã€‚

åŸºæœ¬è¯­æ³•ï¼š
```py
{
  $accumulator: {
    init: <åˆå§‹åŒ–å‡½æ•°>,          // åˆå§‹åŒ–ç´¯åŠ çŠ¶æ€çš„å‡½æ•°ï¼ˆè¿”å›åˆå§‹å€¼ï¼‰
    accumulate: <ç´¯åŠ å‡½æ•°>,      // å¤„ç†å•ä¸ªæ–‡æ¡£ï¼Œæ›´æ–°ç´¯åŠ çŠ¶æ€
    accumulateArgs: [<å‚æ•°åˆ—è¡¨>], // ä¼ é€’ç»™ accumulate å‡½æ•°çš„å‚æ•°ï¼ˆå¯å¼•ç”¨å­—æ®µï¼‰
    merge: <åˆå¹¶å‡½æ•°>,           // åˆå¹¶ä¸åŒåˆ†ç‰‡/çº¿ç¨‹çš„ç´¯åŠ çŠ¶æ€
    finalize: <ç»ˆæ­¢å‡½æ•°>,        // ï¼ˆå¯é€‰ï¼‰å¯¹æœ€ç»ˆç»“æœè¿›è¡Œåå¤„ç†
    lang: "js"                   // ç›®å‰ä»…æ”¯æŒ JavaScript
  }
}
```

init åˆå§‹åŒ–ç´¯åŠ å™¨çš„çŠ¶æ€ï¼ˆå¦‚ () => ({ sum: 0, count: 0 })ï¼‰ã€‚

accumulate	å¯¹æ¯ä¸ªæ–‡æ¡£æ‰§è¡Œï¼Œæ›´æ–°ç´¯åŠ çŠ¶æ€ï¼ˆå¦‚ (state, value) => { state.sum += value }ï¼‰ã€‚

merge	åˆå¹¶å¤šä¸ªåˆ†ç‰‡/å¹¶è¡Œè®¡ç®—çš„ä¸­é—´ç»“æœï¼ˆå¦‚ (state1, state2) => { ... }ï¼‰ã€‚

finalize	ï¼ˆå¯é€‰ï¼‰å¯¹æœ€ç»ˆçŠ¶æ€è¿›è¡ŒåŠ å·¥ï¼ˆå¦‚ (state) => state.sum / state.countï¼‰ã€‚

```py
# æ ¹æ® scoreï¼ˆåˆ†æ•°ï¼‰å’Œ weightï¼ˆæƒé‡ï¼‰å­—æ®µï¼Œè®¡ç®—åˆ†ç»„çš„åŠ æƒå¹³å‡åˆ†
# åŠ æƒå¹³å‡ = Î£(score * weight) / Î£(weight)
{
    $group: {
      _id: "$class",
      weightedAvg: {
        $accumulator: {
          init: function() { 
            return { totalScore: 0, totalWeight: 0 }; 
          },
          accumulate: function(state, score, weight) {
            state.totalScore += score * weight;
            state.totalWeight += weight;
            return state;
          },
          accumulateArgs: ["$score", "$weight"], // ä¼ é€’å­—æ®µå€¼ä½œä¸ºå‚æ•°
          merge: function(state1, state2) {
            return {
              totalScore: state1.totalScore + state2.totalScore,
              totalWeight: state1.totalWeight + state2.totalWeight
            };
          },
          finalize: function(state) {
            return state.totalScore / state.totalWeight;
          },
          lang: "js"
        }
      }
    }
}
```

è‡ªå®šä¹‰ JavaScript ä»£ç æ‰§è¡Œæ•ˆç‡ä½äºå†…ç½®æ“ä½œç¬¦ï¼ˆå¦‚ $sumã€$avgï¼‰ã€‚
å‡½æ•°ä½“éœ€ä¸ºå­—ç¬¦ä¸²æˆ–é€šè¿‡ toString() åºåˆ—åŒ–ã€‚
åœ¨ accumulate å’Œ merge ä¸­éœ€è¿”å›æ–°çŠ¶æ€ï¼Œé¿å…ç›´æ¥ä¿®æ”¹è¾“å…¥çŠ¶æ€ã€‚